<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" type="text/css" href="css/popup.css?u=20150701">
    <link rel="stylesheet" type="text/css" href="css/wiwj_phone.css?u=20150701">
    <link rel="stylesheet" type="text/css" href="css/p.css?u=20150701">
    <link rel="stylesheet" type="text/css"
          href="css/iconfont/wiwj_iconfont.css?u=20150701">
    <style type="text/css">
        body, html, #allmap {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: "微软雅黑";
        }

        .wiwj_map .numicona,.wiwj_map .numiconb,.wiwj_map .numiconc,.wiwj_map .numicond {position:absolute; top:150px; left:150px; width:30px; height:30px; line-height:30px; border-radius:15px; background:rgba(255,137,167,0.9); color:#fff; text-align:center;}
        .wiwj_map .numiconb {top:260px; left:220px; width:70px; height:70px; line-height:70px; border-radius:35px; background:rgba(140,145,255,0.9);}
        .wiwj_map .numiconc {top:350px; left:50px; background:url(../images/wiwj_coordnumicon.png) no-repeat; background-size:30px;}
        .wiwj_map .numicond {top:210px; left:100px; width:100px; height:100px; line-height:100px; border-radius:50px; border:1px solid #64cff9; background:rgba(199,207,249,0.4);}
        .wiwj_map .numicond i {display:inline-block; width:16px; height:16px; border-radius:8px; border:2px solid #fff; background:#64cff9;}

        .BMapLabel{
            border: none;
        }
    </style>
    <script type="text/javascript" src="js/zepto/zepto.js"></script>
    <script type="text/javascript" src="js/a.js"></script>
    <script type="text/javascript" charset="utf-8"
            src="http://api.map.baidu.com/getscript?v=1.5&ak=48b233d1319785d0d9ad2923a4571689&services=&t=20141230041605"></script>
    <title>地图展示</title>
</head>
<body class="wiwj_map">
<div id="allmap"></div>
</body>
<script type="text/javascript">
    var pWin = window.parent;
    var map;
    var myGeo;
    var geolocation;
    var myMarker;
    var cityPoint=null;
    $(function() {
        map = new BMap.Map("allmap");
        myGeo = new BMap.Geocoder();
        // 百度地图API功能
        //map.centerAndZoom(new BMap.Point(116.404, 39.915), 11); // 初始化地图,设置中心点坐标和地图级别
        //map.addControl(new BMap.MapTypeControl());   //添加地图类型控件
        //map.setCurrentCity("北京"); // 设置地图显示的城市 此项是必须设置的
        map.enableScrollWheelZoom(); //开启鼠标滚轮缩放
        /* 	map.addControl(new BMap.NavigationControl({
         offset : {
         y : -64
         }
         })); */
        //geolocation
        var hashObj = A.Util.parseHash(window.location.href);
        var x =parseFloat(hashObj.param.x);
        var y = parseFloat(hashObj.param.y);
        var hcount = hashObj.param.hcount;
        var htext = hashObj.param.htext;
        if (x && y) {
            map.centerAndZoom(new BMap.Point(x+0.008, y), 16);
            var l=	new BMap.Label("<div style='top:-80px;left:-80px;' class='wiwj_detailssitmc'><div class='crtpos'><dl class='crtposmc'><dt><i class='icon-curpos'><em>"+hcount+"套</em></i></dt><dd>"+
                    decodeURIComponent(htext)+"</dd</dl></div></div>", {
                position : new BMap.Point(x, y)
            });
            l.setStyle({ border : "none" }) ;
            l.addEventListener("click", function(e) {
                pWin.A.Router.goTo("#map2_section?mapkey="+hashObj.param.t+"&communityId="+hashObj.param.communityId);
            });
            map.addEventListener("click", function(){
                pWin.A.Router.goTo("#map2_section?mapkey="+hashObj.param.t+"&communityId="+hashObj.param.communityId);

            });
            map.addOverlay(l);
            map.disableDragging();
            map.disableScrollWheelZoom();
            map.disableDoubleClickZoom();
            map.disableKeyboard();
        } else {
            geolocation = new BMap.Geolocation();
            map.addEventListener("zoomend", function(e) {
                mapZoomEnd(e, window);
            });
            map.addEventListener("moveend", function(e) {
                mapMoveEnd(e, window)
            });
            if (hashObj.param.t == "list" && pWin.cur_x && pWin.cur_y
                    && pWin.cur_z) {
                map.centerAndZoom(new BMap.Point(pWin.cur_x, pWin.cur_y),
                        pWin.cur_z);
            } else {
                setCenterByAddress(pWin.A.cityName);
            }
            //locateMy();
        }
    });

    function MapOlyA(x, y, className, html) {
        this._center = new BMap.Point(x, y);
        this._html = html;
        this._className = className;
    }
    MapOlyA.prototype = new BMap.Overlay();
    MapOlyA.prototype.initialize = function(map) {
        this._map = map;
        var em = document.createElement("em");
        em.innerHTML = this._html;
        //em.className = this._className;
        map.getPanes().markerPane.appendChild(em);
        // 保存div实例
        this._em = em;
        return em;
    }
    MapOlyA.prototype.draw = function() {
        // 根据地理坐标转换为像素坐标，并设置给容器
        var position = this._map.pointToOverlayPixel(this._center);
        this._em.style.left = position.x - this._length / 2 + "px";
        this._em.style.top = position.y - this._length / 2 + "px";
    }// 实现显示方法
    MapOlyA.prototype.show = function() {
        if (this._em) {
            this._em.style.display = "block";
        }
    }
    // 实现隐藏方法
    MapOlyA.prototype.hide = function() {
        if (this._em) {
            this._em.style.display = "none";
        }
    }

    function setCenterByAddress(address, zoom) {
        if (!zoom) {
            zoom = 12;
        }
        myGeo.getPoint(address, function(point) {
            if (point) {
                pWin.A.cityPoint=point;
                map.centerAndZoom(point, zoom);
            }
        }, pWin.A.cityName);
    }

    function setCenterCityPoint(){
        if (pWin.A.cityPoint!=null){
            map.setCenter(pWin.A.cityPoint);
        }

    }

    function getCity(callback) {
        myGeo.getLocation(map.getCenter(), function(result) {
            if (result) {
                for (var i = 0; i < pWin.citys.length; i++) {
                    if (result.address.indexOf(pWin.citys[i].name) >= 0) {
                        callback(pWin.citys[i]);
                        return;
                    }
                }
            }
        });
    }

    function locateMy(location) {
        /* if(myMarker){
         map.setCenter(myMarker.getPosition());
         } */
        A.showToast("正在定位","info");
        if(location){
            A.hideToast();
            if (myMarker) {
                map.removeOverlay(myMarker);
            }
            myMarker = new BMap.Label("<em class='numicond' style='left:-50px;top:-50px;'><i></i></em>", {
                position : new BMap.Point(location.longtitude,location.latitude)
            });
            myMarker.setStyle({ border : "none" }) ;
            map.addOverlay(myMarker);
            map.setCenter(myMarker.getPosition());
        }else{
            geolocation.getCurrentPosition(function(e) {
                if (e) {
                    A.hideToast();
                    if (myMarker) {
                        map.removeOverlay(myMarker);
                    }
                    /* myMarker = new BMap.Marker(e.point, {
                     icon : new BMap.Icon("images/wiwj_coordicon.png",
                     new BMap.Size(64, 64))
                     });
                     */
                    myMarker = new BMap.Label("<em class='numicond' style='left:-50px;top:-50px;'><i></i></em>", {
                        position : e.point
                    });
                    myMarker.setStyle({ border : "none" }) ;
                    map.addOverlay(myMarker);
                    map.setCenter(myMarker.getPosition());
                }
            }, {
                enableHighAccuracy : true
            });
        }
    }

    function clearOver(){
        map.clearOverlays();
        if(myMarker){
            map.addOverlay(myMarker);
        }
    }

    function mapZoomEnd(e, w) {
        if (pWin.cur_mapZoomEnd) {
            pWin.cur_mapZoomEnd(e, w);
        }
    }

    function mapMoveEnd(e, w) {
        if (pWin.cur_mapZoomEnd) {
            pWin.cur_mapMoveEnd(e, w);
        }
    }
</script>
</html>